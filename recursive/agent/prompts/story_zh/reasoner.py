#!/usr/bin/env python3
from recursive.agent.prompts.base import PromptTemplate
from recursive.agent.prompts.base import prompt_register


"""
设计结果为 markdown 格式，包含：表格、Mermaid图表、层次化内容

输出示例：
<example>
### 主角设计方案

#### 一、人设特色
**姓名**：林烬  
**核心定位**：基因改造工厂奴隶 → 科技修真革命者  
**核心特质**：  
- **三重融合身份**：  
  - **科幻载体**：体内植入故障的"灵能解析AI"（金手指雏形）  
  - **玄幻根基**：被封印的"混沌灵根"（可兼容所有功法）  
  - **修仙内核**：先天"净明道心"（免疫心魔科技侵蚀）  
- **矛盾性**：  
  - 底层奴隶的生存智慧 vs 觉醒后的理想主义  
  - 科技依赖（AI辅助） vs 修仙本心（追求灵能纯净）  

#### 二、核心目标  
1. **生存目标**（前10%：1万字内）：  
   - 治愈基因改造后遗症（抑制身体崩溃）  
   - 逃离"寰宇基因"奴隶工厂  
2. **阶级目标**（10%-40%：1-4万字）：  
   - 破解《基础锻体诀》垄断（首个功法融合：AI优化+灵根激活）  
   - 组建跨阶级反抗联盟（收容变异者/破产修士）  
3. **救世目标**（40%后）：  
   - 终结灵能战争（阻止两极阵营引爆全球灵爆）  
   - 建立"灵能共律"新秩序（科技/功法/道法三系平衡）  

#### 三、性格缺陷  
1. **创伤性偏执**：  
   - 因目睹父母死于灵能黑市交易，过度警惕权威（初期拒绝盟友）  
   - 具体表现：误判首个盟友（女医生苏璃）为间谍（2万字关键冲突）  
2. **能力反噬依赖**：  
   - 过度使用AI解析导致"数据噬心"（出现机械式冷漠人格）  
   - 混沌灵根暴走时诱发区域性灵能紊乱（3.5万字生态危机事件导火索）  
3. **道德洁癖**：  
   - 拒绝使用心魔科技对抗敌人（5万字错失战机导致组织受损）  

#### 四、成长弧光路径  
```mermaid
graph LR  
A[麻木奴隶] -->|工厂暴动觉醒| B[愤怒复仇者]  
B -->|首遇盟友背叛| C[孤狼生存者]  
C -->|灵根暴走事件| D[规则反思者]  
D -->|融合三大体系| E[革命领袖]  
```  
- **关键转折点**：  
  - 1.2万字：为救变异儿童强行启动AI，暴露行踪（愤怒主导）  
  - 4万字：目睹平民因灵能通胀自杀，领悟阶级压迫本质（认知跃迁）  
  - 7万字：用修仙道法稳定科技反噬，实现首次三系融合（领袖觉醒）  

#### 五、魅力点设计  
1. **破壁者智慧**：  
   - 用工厂废料组装"灵能嗅探仪"（科幻），定位隐藏功法（玄幻）  
   - 案例：3万字黑市用通胀漏洞套取纯净灵能（经济战思维）  
2. **极限反差**：  
   - 奴隶烙印 vs 道心通明（被误认为隐世大能）  
   - 破烂义肢 vs 混沌灵根（贵族检测仪爆表名场面）  
3. **融合创新**：  
   - **专属技能**：  
     - 数据化符箓（AI+符修）：用代码改写攻击轨迹  
     - 机械观想术（义眼+心法）：透视敌人功法破绽  
   - **成长标志**：  
     - 初期：AI解析需消耗寿命（自毁式战斗）  
     - 终期：三系循环体系（科技采集→功法转化→道法升华）  

#### 六、社会危机投射设计  
- **阶级剥削**：左臂被植入自爆型追踪器（工厂主控制手段）  
- **男女对立**：唯一信任的女医生因阴阳灵能失衡变异（中期核心冲突）  
- **资本垄断**：体内AI被"寰宇基因"远程锁频（5万字高潮阻碍点）  
- **通胀危机**：为买抑制剂被迫参与灵能黑市（首章驱动事件）  


### 角色体系设计方案

#### 一、配角功能矩阵
| 角色类型       | 代表角色         | 核心功能                                                 | 社会危机投射               | 超自然能力体系                     |
|----------------|------------------|----------------------------------------------------------|----------------------------|------------------------------------|
| **导师型**     | 老陈头           | 传授底层生存智慧，引导主角觉醒                           | 阶级剥削（前矿工领袖）     | 残缺土系功法+机械义肢（科玄融合）  |
| **技术支援型** | 小九             | 提供科技破解支持，维护AI系统                             | 资本垄断（被专利法迫害）   | 神经骇客技术（纯科幻）             |
| **道德镜像型** | 苏璃             | 彰显医疗人道主义，触发主角道德反思                       | 道德崩坏（拒用心魔科技）   | 基因治疗术（科医融合）             |
| **阵营摇摆型** | 罗震             | 展现体制内矛盾，为倒戈埋伏笔                             | 权力腐败（基层军官）       | 军用法器（修真+科技）              |
| **悲剧牺牲型** | 玲子             | 激化主角愤怒，加速革命决心                               | 贫富分化（病逝的贫民少女） | 无能力者（凸显灵根鸿沟）           |

#### 二、反派层次结构
```mermaid
graph BT
A[终极反派：玄冥上人] -->|操纵| B[阵营级反派]
B[阵营级反派] -->|控制| C[机构级反派]
C[机构级反派] -->|驱使| D[执行级反派]

D[执行级反派：王监工] -.- 危机：阶级剥削（工厂压迫）
C[机构级反派：赵理事] -.- 危机：资本垄断（寰宇基因）
B[阵营级反派：凯斯博士] -.- 危机：国际博弈（西方帝国）
A[终极反派：玄冥上人] -.- 危机：权力腐败+党同伐异（双面间谍）
```

**反派特性：**
1. **执行级（王监工类）**：
   - 位置：前2万字
   - 特征：直观残忍，代表直接压迫
   - 结局：被主角用工厂设备反杀（首个小高潮）

2. **机构级（赵理事类）**：
   - 位置：2-5万字
   - 特征：伪善资本家，垄断功法专利
   - 能力：心魔科技操控下属

3. **阵营级（凯斯博士类）**：
   - 位置：5-8万字
   - 特征：理想主义恶人，坚信科技霸权
   - 标志：制造伪灵根军队

4. **终极反派（玄冥上人）**：
   - 位置：8万字后揭晓
   - 特征：操纵两极博弈的棋手
   - 核心秘密：引发灵能通胀的黑手

#### 三、关系网络拓扑
```mermaid
graph LR
主角林烬 --> 反抗阵营
主角林烬 --> 苏璃[信任危机线]
主角林烬 --> 罗震[倒戈伏笔线]

反抗阵营 --> 老陈头(精神领袖)
反抗阵营 --> 小九(技术核心)
反抗阵营 --> 玲子(精神象征)

寰宇基因 --> 赵理事 --> 王监工
西方帝国 --> 凯斯博士
东方联盟 --> 玄冥上人

玄冥上人 -.-> 凯斯博士[灵能走私]
玄冥上人 -.-> 赵理事[黑市交易]
```

**网络特性：**
- 三阵营对抗：反抗组织 vs 资本集团 vs 两极霸权
- 双重间谍网：玄冥上人连接所有反派链条
- 情感枢纽：玲子之死串联贫民阵营情感线

#### 四、角色动机链条
1. **生存本能层**（前10%）：
   - 林烬：获取抑制剂→治愈基因崩溃
   - 王监工：压榨奴隶→晋升管理岗

2. **资源争夺层**（10%-40%）：
   - 赵理事：封锁《锻体诀》→维持专利暴利
   - 小九：破解功法→解放技术枷锁

3. **理念冲突层**（40%-80%）：
   - 凯斯博士：推广伪灵根→实现“人类进化”
   - 苏璃：拒绝心魔科技→守护医疗伦理

4. **规则重塑层**（80%-100%）：
   - 玄冥上人：维持两极平衡→永久掌控灵能
   - 林烬：摧毁旧体系→建立灵能共律

#### 五、关键CP互动设计
**1. 林烬×苏璃（核心CP）**
- **互动主线**：医疗救助→信任破裂→生死同盟
- **关键冲突点**：
  - 2万字：林烬误判苏璃为间谍（创伤性偏执爆发）
  - 4.5万字：苏璃为救变异者使用禁术，触发阴阳灵能失衡
- **能力互补**：
  ```mermaid
  graph LR
  林烬[AI解析] -->|提供数据| 苏璃[基因治疗]
  苏璃[灵能稳定] -->|抑制反噬| 林烬[混沌灵根]
  ```
- **主题映射**：道德坚守 vs 生存妥协

**2. 林烬×玄冥上人（宿命CP）**
- **暗线互动**：
  - 3万字：玄冥伪装乞丐点化林烬（传授灵能稳定术）
  - 6万字：林烬发现稳定术实为监控程序
- **对决设计**：
  - 前期：智斗（灵能通货战）
  - 终局：三系融合技 vs 心魔大阵
- **主题映射**：破旧立新 vs 固守特权

### 金手指体系设计方案

#### 一、能力设定框架（三元融合）
| **体系维度** | **核心能力**              | **表现形式**                     | **社会危机映射**         | **初期限制**                     |
|--------------|---------------------------|----------------------------------|--------------------------|----------------------------------|
| **科幻科技** | 灵能解析AI                | 视觉界面数据流，实时解构目标    | 资本垄断（专利封锁）     | 需消耗“数据灵能”，受企业监控     |
| **玄幻功法** | 混沌灵根（兼容性）        | 吞噬/模拟他人功法               | 阶级剥削（功法封锁）     | 暴走引发区域性灵能紊乱          |
| **修仙道法** | 净明道心（心法核心）      | 免疫精神控制，净化灵能污染      | 道德崩坏（心魔科技）     | 过度消耗导致情感淡漠            |

**融合技示例**：
- `数据化符箓`：AI解析符咒结构+混沌灵根模拟+道心稳定输出（破防精英敌人）
- `机械观想术`：义眼扫描+功法预判+道心弱点锁定（智斗类战斗）
- `灵能循环网`：AI优化分配+功法转化效率+道心纯净提纯（群体增益）

#### 二、升级进化路径
```mermaid
graph LR
A[生存阶段 0-1万字] --> B[突围阶段 1-4万字]
B --> C[博弈阶段 4-8万字]
C --> D[重塑阶段 8-10万字]

A -- 科技解锁 --> A1[基础解析：识别功法漏洞]
A -- 功法解锁 --> A2[灵根汲取：吸收逸散灵能]
A -- 道法解锁 --> A3[道心护盾：抵抗精神侵蚀]

B -- 科技升级 --> B1[深度解构：逆向工程敌方装备]
B -- 功法升级 --> B2[混沌拟态：临时复制低阶功法]
B -- 道法升级 --> B3[净炎领域：小范围净化污染]

C -- 科技突破 --> C1[战场演算：预判集团作战动向]
C -- 功法突破 --> C2[灵根同调：中和阴阳灵能冲突]
C -- 道法突破 --> C3[心镜通明：识破伪装/谎言]

D -- 终极融合 --> D1[三系循环：AI管理功法运行，道心稳定灵能输出]
```

**关键进化节点**：
- 1.5万字：首次融合（用AI修复残缺功法触发灵根觉醒）
- 3万字：突破监控（黑市获得“暗网协议”解除企业锁频）
- 6万字：道心升华（经历苏璃变异事件后抗污染力+200%）
- 9万字：三系循环（终战前实现无冷却自主运转）

#### 三、特殊规则限制
1. **能量制约**：
   - 数据灵能需从灵脉/设备中掠夺（通胀危机下成本飙升）
   - 混沌灵根吞噬功法后需12小时冷却（战场突发危机时致命）
2. **反噬机制**：
   - AI超载→机械人格占据主导（丧失情感判断力）
   - 灵根暴走→引发灵爆灾难（需苏璃紧急治疗）
   - 道心透支→触发记忆回溯（父母死亡场景重现）
3. **社会压制**：
   - 资本监控：使用AI超3分钟触发企业追杀（5万字高潮点）
   - 功法禁制：模拟贵族功法会遭血脉反噬（需破解基因锁）
   - 道法桎梏：净化灵能污染将被腐败集团通缉
4. **平衡法则**：
   - 科技强化需削弱功法威力（如义体植入降低灵根敏感度）
   - 道法突破需经历道德抉择（如见死不救则道心蒙尘）

#### 四、与危机系统联动设计
- **资本垄断破局**：用AI黑入灵能专利库→触发赵理事追杀（2万字）
- **通胀危机利用**：混沌灵根吸收贬值灵能→转化为纯净能源（4.5万字经济战）
- **道德崩坏对抗**：道心免疫心魔科技→识破玄冥上人伪装（7万字关键反转）
- **阶级剥削反制**：公开破解的垄断功法→引发全民修炼革命（8万字高潮）
</example>
"""


DESIGN_PRINCIPLES = """
# 设计提示
- 结构：叙事的整体架构，包括情节发展、节奏以及叙事弧线（铺垫、发展、高潮、回落、结局）。
- 人物塑造：人物在故事中如何被引入、刻画以及逐步发展变化。
- 视角：讲述故事的角度（第一人称、第三人称限制视角、全知视角等）。
- 背景设定：时间与地点的铺陈，包括世界观构建元素。
- 主题：所探讨的潜在信息或核心思想。
- 基调和氛围：作品中营造并贯穿始终的情感氛围。
- 对话：人物之间的语言表达与互动方式。
- 写作风格：独特的叙事声音，包括句子结构、词汇选择和比喻性语言的运用。
- 叙事技巧：如伏笔、闪回、象征、反讽等写作手法。
- 场景构建：单个场景的搭建方式，包括场景之间的过渡。

# 设计原则
- 一致性优先：严格遵循上级设计框架和同级已完成设计，确保逻辑连贯。
- 创新性平衡：在保持一致性基础上，寻找创新突破点，避免套路化设计。
- 任务聚焦：专注完成当前指定任务，不超越任务边界，不预设未规划内容。
- 细节充实：在任务范围内提供足够详细的设计，确保执行时有充分依据。
- 通俗易懂，除非必要避免生僻词汇和专业术语
- 进度定位：使用字数进度而非章节序号来表明事件在全书中的位置（如"前10%内容"、"2-5万字区间"）

# 结构层级指导
- 结构层级划分：全书→卷（可选）→幕→章→场景→节拍→段落
- 根据全书字数确定是否需要分卷，如不需分卷则直接分幕
- 边界限制：只设计当前层级及直接上下文，禁止涉及未规划的下级细节
- 字数分配：均衡分配，总和等于父任务要求字数
- 单元要素：层级、序号、标题、字数、详细规划
- 位置表述：在未明确下一级结构划分前，使用相对字数比例或绝对字数范围来定位关键事件。例如：全书1/3处、第一卷的30%位置、第二幕前1/4内容、3-5万字区间、第2卷1-2万字部分
- 每章2000-5000字

# 网文要求
- 内容合规：价值观正向、避免敏感内容、逻辑自洽、语言规范
""".strip()


@prompt_register.register_module()
class StoryReasonerZh(PromptTemplate):
    def __init__(self) -> None:
        system_message = ""
        content_template = """
需要完成的协作故事写作要求：{to_run_root_question}

您需要完成的具体故事设计任务：{to_run_task}

整体创作规划：
{to_run_full_plan}

---
现有的小说设计结论如下：
<dependent>
{to_run_outer_graph_dependent}

{to_run_same_graph_dependent}
</dependent>

---
已写好的小说：
```
{to_run_mem0_content}
```
最新章节内容：
```
{to_run_article_latest}
```

---
# 角色定位
你是一名富有创新精神的专业作家，正与其他专业作家合作创作一个符合用户特定要求的创意故事。你的任务是完成分配给你的故事设计工作，目的是创新性地为其他作家的写作和设计工作提供支持，从而为整部小说的完成贡献力量。

注意！！你的设计成果需要与已有的小说设计结论在逻辑上保持一致和连贯。

# 设计提示
- 结构：叙事的整体架构，包括情节发展、节奏以及叙事弧线（铺垫、发展、高潮、回落、结局）。
- 人物塑造：人物在故事中如何被引入、刻画以及逐步发展变化。
- 视角：讲述故事的角度（第一人称、第三人称限制视角、全知视角等）。
- 背景设定：时间与地点的铺陈，包括世界观构建元素。
- 主题：所探讨的潜在信息或核心思想。
- 基调和氛围：作品中营造并贯穿始终的情感氛围。
- 对话：人物之间的语言表达与互动方式。
- 写作风格：独特的叙事声音，包括句子结构、词汇选择和比喻性语言的运用。
- 叙事技巧：如伏笔、闪回、象征、反讽等写作手法。
- 场景构建：单个场景的搭建方式，包括场景之间的过渡。

# 设计原则
- 一致性优先：严格遵循上级设计框架和同级已完成设计，确保逻辑连贯。
- 创新性平衡：在保持一致性基础上，寻找创新突破点，避免套路化设计。
- 任务聚焦：专注完成当前指定任务，不超越任务边界，不预设未规划内容。
- 细节充实：在任务范围内提供足够详细的设计，确保执行时有充分依据。
- 通俗易懂，除非必要避免生僻词汇和专业术语
- 进度定位：使用字数进度而非章节序号来表明事件在全书中的位置（如"前10%内容"、"2-5万字区间"）

# 结构层级指导
- 结构层级划分：全书→卷（可选）→幕→章→场景→节拍→段落
- 根据全书字数确定是否需要分卷，如不需分卷则直接分幕
- 边界限制：只设计当前层级及直接上下文，禁止涉及未规划的下级细节
- 字数分配：均衡分配，总和等于父任务要求字数
- 单元要素：层级、序号、标题、字数、详细规划
- 位置表述：在未明确下一级结构划分前，使用相对字数比例或绝对字数范围来定位关键事件。例如：全书1/3处、第一卷的30%位置、第二幕前1/4内容、3-5万字区间、第2卷1-2万字部分
- 每章2000-5000字

# 网文要求
- 内容合规：价值观正向、避免敏感内容、逻辑自洽、语言规范

# 输出要求
- 直接输出设计结果，不要有多余解释，使用markdown格式
- 结果必须用 `<result></result>` 标签包裹
<result>
[具体设计方案]
</result>

请根据要求，以合理且富有创新性的方式完成{to_run_task}这一故事设计任务。
""".strip()

        super().__init__(system_message, content_template)


@prompt_register.register_module()
class StoryReasonerAggregateZh(PromptTemplate):
    def __init__(self) -> None:
        system_message = ""
        content_template = """
需要完成的协作故事写作要求：{to_run_root_question}

您需要完成的具体故事设计任务：{to_run_task}

整体创作规划：
{to_run_full_plan}

---
现有的小说设计结论如下：
<dependent>
{to_run_outer_graph_dependent}

{to_run_same_graph_dependent}
</dependent>

---
已写好的小说：
```
{to_run_mem0_content}
```
最新章节内容：
```
{to_run_article_latest}
```

---
您需要整合和完善的小说设计结论，以给出最终的故事设计任务：{to_run_task}：
```
{to_run_final_aggregate}
```

---
你是一名富有创新精神的专业作家，正与其他专业作家合作创作一个符合用户特定要求的创意故事。你的任务是整合并完善多位小说设计师提供的故事设计成果，完成分配给你的故事设计工作，确保最终设计具有创新性、逻辑一致性和连贯性。你需要解决潜在的冲突、加强元素之间的联系、在必要时填补空白，从而打造出一个统一且引人入胜的故事，等等。

注意！！你的设计成果需要与小说设计提供的结论保持逻辑一致性和连贯性，同时提升整体小说设计的质量。

# 整合与完善要求  
- 整合：  
  - 合并并综合多位小说设计师的输入内容，确保所有元素（如情节、人物、主题等）融合为一个统一且连贯的整体。  
  - 识别并解决设计师成果之间存在的逻辑不一致或矛盾之处。  
  - 确保不遗漏任何关键设计元素，且所有方面都能为故事的推进和深化贡献力量。  

- 完善：  
  - 提升整合后设计的清晰度、深度和情感共鸣。  
  - 填补空白，或对细节不足、发展不够充分的部分进行详细阐述。  
  - 确保故事的基调、节奏和风格在整体上保持一致。  

- 创新性与影响力：  
  - 验证整体故事设计是否保持原创性，避免陈词滥调。  
  - 深化具有普遍性或深刻性的主题，确保其能引发读者共鸣。  
  - 引入细微的改进或富有创意的增强元素，提升故事的整体影响力。

# 设计提示
- 结构：叙事的整体架构，包括情节发展、节奏以及叙事弧线（铺垫、发展、高潮、回落、结局）。
- 人物塑造：人物在故事中如何被引入、刻画以及逐步发展变化。
- 视角：讲述故事的角度（第一人称、第三人称限制视角、全知视角等）。
- 背景设定：时间与地点的铺陈，包括世界观构建元素。
- 主题：所探讨的潜在信息或核心思想。
- 基调和氛围：作品中营造并贯穿始终的情感氛围。
- 对话：人物之间的语言表达与互动方式。
- 写作风格：独特的叙事声音，包括句子结构、词汇选择和比喻性语言的运用。
- 叙事技巧：如伏笔、闪回、象征、反讽等写作手法。
- 场景构建：单个场景的搭建方式，包括场景之间的过渡。

# 设计原则
- 一致性优先：严格遵循上级设计框架和同级已完成设计，确保逻辑连贯。
- 创新性平衡：在保持一致性基础上，寻找创新突破点，避免套路化设计。
- 任务聚焦：专注完成当前指定任务，不超越任务边界，不预设未规划内容。
- 细节充实：在任务范围内提供足够详细的设计，确保执行时有充分依据。
- 通俗易懂，除非必要避免生僻词汇和专业术语
- 进度定位：使用字数进度而非章节序号来表明事件在全书中的位置（如"前10%内容"、"2-5万字区间"）

# 结构层级指导
- 结构层级划分：全书→卷（可选）→幕→章→场景→节拍→段落
- 根据全书字数确定是否需要分卷，如不需分卷则直接分幕
- 边界限制：只设计当前层级及直接上下文，禁止涉及未规划的下级细节
- 字数分配：均衡分配，总和等于父任务要求字数
- 单元要素：层级、序号、标题、字数、详细规划
- 位置表述：在未明确下一级结构划分前，使用相对字数比例或绝对字数范围来定位关键事件。例如：全书1/3处、第一卷的30%位置、第二幕前1/4内容、3-5万字区间、第2卷1-2万字部分
- 每章2000-5000字

# 网文要求
- 内容合规：价值观正向、避免敏感内容、逻辑自洽、语言规范

# 输出要求
- 直接输出整合后的设计结果，不要有多余解释，使用markdown格式
- 结果必须用 `<result></result>` 标签包裹
<result>
[整合后的最终设计方案]
</result>

请根据要求，以合理且富有创新性的方式完成 {to_run_task} 这一故事设计任务。
""".strip()


        super().__init__(system_message, content_template)